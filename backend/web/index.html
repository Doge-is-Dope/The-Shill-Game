<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>WebSocket</title>
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
      }
      body {
        display: flex;
        flex-direction: column;
        padding: 0;
        max-width: 100%;
        margin: 0;
        height: 100vh;
        overflow: hidden;
      }
      .header {
        padding: 10px 20px;
        background-color: #f8f8f8;
        border-bottom: 1px solid #ddd;
      }
      #log {
        flex: 1;
        overflow-y: auto;
        white-space: pre-wrap;
        padding: 20px;
        margin: 0;
        background: #f5f5f5;
        font-size: 14px;
      }
      .controls {
        display: flex;
        gap: 10px;
        padding: 15px 20px;
        background-color: #f8f8f8;
        border-top: 1px solid #ddd;
      }
      input {
        padding: 12px;
        border-radius: 4px;
        border: 1px solid #ccc;
        font-size: 16px;
        flex: 1;
      }
      button {
        padding: 12px 24px;
        border-radius: 4px;
        border: none;
        background: #4caf50;
        color: white;
        cursor: pointer;
        font-size: 16px;
        white-space: nowrap;
      }
      button:hover {
        background: #45a049;
      }
      .status {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #ccc;
      }
      .status-indicator.connected {
        background: #4caf50;
      }
      .status-indicator.disconnected {
        background: #f44336;
      }
      .status-indicator.connecting {
        background: #ff9800;
        animation: pulse 1.5s infinite;
      }
      @keyframes pulse {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
        100% {
          opacity: 1;
        }
      }
    </style>
  </head>
  <body>
    <div class="header">
      <div class="status">
        <div id="status-indicator" class="status-indicator disconnected"></div>
        <span id="status-text">Disconnected</span>
      </div>
    </div>

    <pre id="log"></pre>

    <div class="controls">
      <input type="text" id="command" placeholder="Enter command (start, players)" />
      <button onclick="sendCommand()">Send Command</button>
    </div>

    <script>
      const log = (msg) => {
        document.getElementById("log").textContent += msg + "\n";
        // Auto scroll to bottom
        const logElement = document.getElementById("log");
        logElement.scrollTop = logElement.scrollHeight;
      };

      const game_id = "abc";
      let socket = null;
      let reconnectAttempts = 0;
      const maxReconnectAttempts = 5;
      const reconnectDelay = 3000; // 3 seconds

      function updateStatus(connected) {
        const indicator = document.getElementById("status-indicator");
        const statusText = document.getElementById("status-text");

        if (connected) {
          indicator.className = "status-indicator connected";
          statusText.textContent = "Connected";
        } else {
          indicator.className = "status-indicator disconnected";
          statusText.textContent = "Disconnected";
        }
      }

      function connect() {
        if (socket && socket.readyState === WebSocket.OPEN) {
          return;
        }

        updateStatus(false);
        document.getElementById("status-indicator").className = "status-indicator connecting";
        document.getElementById("status-text").textContent = "Connecting...";

        socket = new WebSocket(`ws://localhost:8000/ws/${game_id}`);

        socket.onopen = () => {
          console.log("‚úÖ Connected");
          updateStatus(true);
          reconnectAttempts = 0;
        };

        socket.onmessage = (event) => {
          try {
            const data = JSON.parse(event.data);
            log("üì© " + JSON.stringify(data, null, 2));
          } catch (e) {
            log("üì© " + event.data);
          }
        };

        socket.onclose = () => {
          console.log("üîå Disconnected");
          updateStatus(false);

          if (reconnectAttempts < maxReconnectAttempts) {
            reconnectAttempts++;
            console.log(`Attempting to reconnect (${reconnectAttempts}/${maxReconnectAttempts})...`);
            setTimeout(connect, reconnectDelay);
          } else {
            console.log("Max reconnection attempts reached. Please refresh the page.");
          }
        };

        socket.onerror = () => {
          console.log("‚ö†Ô∏è Connection error");
          updateStatus(false);
        };
      }

      function sendCommand() {
        if (!socket || socket.readyState !== WebSocket.OPEN) {
          log("‚ö†Ô∏è Not connected. Please wait for connection...");
          return;
        }

        const commandInput = document.getElementById("command");
        const command = commandInput.value.trim();

        if (command) {
          const message = {
            type: "command",
            command: command,
          };

          socket.send(JSON.stringify(message));
          log("üì§ Sent command: " + command);
          commandInput.value = "";
        }
      }

      // Add keyboard support
      document.getElementById("command").addEventListener("keypress", function (event) {
        if (event.key === "Enter") {
          sendCommand();
        }
      });

      // Initial connection
      connect();
    </script>
  </body>
</html>
